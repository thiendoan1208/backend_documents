1. Hash password with bycypt

https://www.npmjs.com/package/bcrypt

+ sá»­ dá»¥ng sync 

import bcrypt from "bcrypt";

const hashPassword = async (password) => {
  const saltRounds = 10;
  const salt = await bcrypt.genSalt(saltRounds);
  const hash = await bcrypt.hash(password, salt);
  return hash;
};

export { hashPassword };


	* Random User id 
	
	( https://www.npmjs.com/package/uuid )




2. ORM & Setup Sequelize  ( lÆ°u Ã½ dÃ¹ng vá»›i commonjs Ä‘á»ƒ trÃ¡nh lá»—i migration )

	1. ORM

+ ORM (Object-Relational Mapping) lÃ  má»™t ká»¹ thuáº­t láº­p trÃ¬nh cho phÃ©p báº¡n thao tÃ¡c vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u báº±ng cÃ¡ch sá»­ dá»¥ng object (Ä‘á»‘i tÆ°á»£ng) thay vÃ¬ viáº¿t cÃ¡c cÃ¢u lá»‡nh SQL thá»§ cÃ´ng. 

ORM giÃºp báº¡n:

	+ Truy váº¥n, chÃ¨n, cáº­p nháº­t, xÃ³a dá»¯ liá»‡u qua Ä‘á»‘i tÆ°á»£ng JS.
	+ KhÃ´ng cáº§n viáº¿t SQL trá»±c tiáº¿p (hoáº·c ráº¥t Ã­t).
	+ Dá»… báº£o trÃ¬ vÃ  phÃ¡t triá»ƒn nhanh hÆ¡n.


	2. Sequelize lÃ  gÃ¬ ?

	+ Sequelize lÃ  má»™t ORM cho Node.js há»— trá»£ nhiá»u loáº¡i cÆ¡ sá»Ÿ dá»¯ liá»‡u nhÆ°:

	MySQL, PostgreSQL, SQLite, MariaDB

	> NÃ³ giÃºp báº¡n Ä‘á»‹nh nghÄ©a models, táº¡o migration, vÃ  tÆ°Æ¡ng tÃ¡c vá»›i DB dá»… dÃ ng.

	3. Sequelize CLI lÃ  gÃ¬ ?

	+ KhÃ´ng báº¯t buá»™c, nhÆ°ng náº¿u báº¡n muá»‘n dÃ¹ng migration, seed, tá»± Ä‘á»™ng táº¡o folder chuáº©n, thÃ¬ nÃªn dÃ¹ng sequelize-cli.

	+ sequelize-cli lÃ  cÃ´ng cá»¥ dÃ²ng lá»‡nh chÃ­nh thá»©c cá»§a Sequelize Ä‘á»ƒ giÃºp báº¡n:

Táº¡o folder models, migrations, seeders, config tá»± Ä‘á»™ng.

Dá»… dÃ ng táº¡o model báº±ng lá»‡nh: sequelize model:generate

Dá»… cháº¡y migration: sequelize db:migrate

Táº¡o dá»¯ liá»‡u máº«u: sequelize db:seed
	


	4. Setup dá»± Ã¡n vá»›i Sequelize vÃ  Sequelize CLI

	B1.

npm install sequelize 
npm install --save-dev sequelize-cli


	B2. táº¡o .sequelizerc Ä‘á»ƒ config nÆ¡i táº¡o ra cÃ¡c: config, migrations, models, seeders 


const path = require('path');

module.exports = {
  'config': path.resolve('src', 'config', 'config.json'),
  'models-path': path.resolve('src', 'models'),
  'seeders-path': path.resolve('src', 'seeders'),
  'migrations-path': path.resolve('src', 'migrations'),
};



	B3. 

npx sequelize-cli init


	* Setup database vÃ  tiáº¿n hÃ nh táº¡o báº£ng Ä‘áº§u tiÃªn 

	B1. Connecting to a database and Testing the connection


	( https://sequelize.org/docs/v6/getting-started/ )

	src/config/connectDB.js 

const { Sequelize } = require('sequelize');

const sequelize = new Sequelize('database', 'username', 'password', {
  host: 'localhost',
  dialect: /* one of 'mysql' | 'postgres' | 'sqlite' | 'mariadb' | 'mssql' | 'db2' | 'snowflake' | 'oracle' */,
  port: number
});
	
const connection = async () => {
  try {
    await sequelize.authenticate();
    console.log("Connection has been established successfully.");
  } catch (error) {
    console.error("Unable to connect to the database:", error);
  }
};

export default connection;

	server.js

connection();


	B2: Creating first model 

( https://sequelize.org/docs/v6/other-topics/migrations/ )

npx sequelize-cli model:generate --name User --attributes firstName:string,lastName:string,email:string

	
	B3: Running migration 


npx sequelize-cli db:migrate

	* LÆ°u Ã½: Congfig database vÃ  config.json sao cho Ä‘Ãºng ( port ) Ä‘á»ƒ trÃ¡nh lá»—i migration vÃ  sá»­ dá»¥ng commonjs 
	
	B4: ThÃªm dá»¯ liá»‡u máº«u = seeder 

npx sequelize-cli seed:generate --name demo-user

	B5: Running seed

npx sequelize-cli db:seed:all

	


3. ORM Structure - Ã nghÄ©a cá»§a Model/Migrations/Seeder 

	1. config/config.json 

Chá»©a thÃ´ng tin cáº¥u hÃ¬nh káº¿t ná»‘i cÆ¡ sá»Ÿ dá»¯ liá»‡u cho tá»«ng mÃ´i trÆ°á»ng:

development: mÃ´i trÆ°á»ng phÃ¡t triá»ƒn

test: mÃ´i trÆ°á»ng test

production: mÃ´i trÆ°á»ng production

> Sequelize CLI sá»­ dá»¥ng file nÃ y Ä‘á»ƒ biáº¿t cÃ¡ch káº¿t ná»‘i vÃ o database khi cháº¡y cÃ¡c lá»‡nh nhÆ° db:migrate, db:seed...



	2. models/


TÃ¡c dá»¥ng:

NÆ¡i Ä‘á»‹nh nghÄ©a cÃ¡c model (báº£ng trong database).

Má»—i file lÃ  má»™t model tÆ°Æ¡ng á»©ng vá»›i 1 báº£ng.

File index.js trong thÆ° má»¥c nÃ y sáº½ tá»± Ä‘á»™ng import vÃ  liÃªn káº¿t cÃ¡c model vá»›i nhau (náº¿u cÃ³ quan há»‡).


	3. migrations/

TÃ¡c dá»¥ng:

Chá»©a cÃ¡c file mÃ´ táº£ sá»± thay Ä‘á»•i cáº¥u trÃºc CSDL theo thá»i gian (schema migration).

GiÃºp quáº£n lÃ½ version vÃ  lá»‹ch sá»­ thay Ä‘á»•i schema.

CÃ³ thá»ƒ rollback hoáº·c migrate tá»›i má»™t tráº¡ng thÃ¡i báº¥t ká»³.

> Khi cháº¡y sequelize db:migrate, cÃ¡c file nÃ y sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n Ä‘á»ƒ táº¡o/cáº­p nháº­t báº£ng trong DB.


	*  TÃ¡c dá»¥ng cá»§a cÃ¡c function up vÃ  down trong file Migration

+ up(queryInterface, Sequelize)

LÃ  hÃ m Ä‘Æ°á»£c gá»i khi báº¡n cháº¡y migration (sequelize db:migrate).

TÃ¡c dá»¥ng: táº¡o hoáº·c chá»‰nh sá»­a báº£ng, thÃªm cá»™t, thÃªm chá»‰ má»¥c, v.v.

NÃ³i Ä‘Æ¡n giáº£n lÃ  "Ã¡p dá»¥ng thay Ä‘á»•i má»›i vÃ o CSDL".


+ down(queryInterface, Sequelize)

LÃ  hÃ m Ä‘Æ°á»£c gá»i khi báº¡n rollback migration (sequelize db:migrate:undo hoáº·c db:migrate:undo:all).

TÃ¡c dá»¥ng: hoÃ n tÃ¡c nhá»¯ng gÃ¬ up() Ä‘Ã£ lÃ m.

NÃ³i Ä‘Æ¡n giáº£n lÃ  "trá»Ÿ vá» tráº¡ng thÃ¡i cÅ©".


	* Báº£ng SequelizeMeta lÃ  gÃ¬?


Báº£ng nÃ y Ä‘Æ°á»£c Sequelize tá»± Ä‘á»™ng táº¡o ra trong CSDL.

Má»¥c Ä‘Ã­ch: theo dÃµi cÃ¡c migration Ä‘Ã£ Ä‘Æ°á»£c cháº¡y.

Má»—i khi báº¡n cháº¡y sequelize db:migrate, Sequelize:

Cháº¡y cÃ¡c file migration chÆ°a cÃ³ tÃªn trong báº£ng SequelizeMeta.

Sau khi cháº¡y xong, nÃ³ sáº½ chÃ¨n tÃªn file migration vÃ o báº£ng nÃ y Ä‘á»ƒ Ä‘Ã¡nh dáº¥u lÃ  Ä‘Ã£ cháº¡y.


	4. seeders/

TÃ¡c dá»¥ng:

Chá»©a cÃ¡c file dÃ¹ng Ä‘á»ƒ thÃªm dá»¯ liá»‡u máº«u vÃ o cÆ¡ sá»Ÿ dá»¯ liá»‡u (dÃ¹ng cho dev/test/demo).

ThÃªm nhiá»u dá»¯ liá»‡u máº«u chá»© k pháº£i lÃ m viá»‡c CRUD

CÃ³ thá»ƒ táº¡o dá»¯ liá»‡u ban Ä‘áº§u cho báº£ng ngÆ°á»i dÃ¹ng, sáº£n pháº©m, v.v.


		
âœ… Tá»•ng káº¿t
ThÆ° má»¥c/file		Vai trÃ² chÃ­nh
config/config.json	Káº¿t ná»‘i CSDL cho tá»«ng mÃ´i trÆ°á»ng
models/			Äá»‹nh nghÄ©a cáº¥u trÃºc báº£ng (Model)
migrations/		Quáº£n lÃ½ thay Ä‘á»•i schema CSDL
seeders/		Táº¡o dá»¯ liá»‡u máº«u ban Ä‘áº§u



	*LÆ°u Ã½: máº·c Ä‘á»‹nh khi táº¡o table sáº½ thÃªm s sau tÃªn. máº·c dÃ¹ nÃ³ khÃ´ng quan trá»ng láº¯m 


 "development": {
    "username": "root",
    "password": "1208",
    "database": "jwt-roles",
    "host": "127.0.0.1",
    "dialect": "mysql",
    "port": "8888",
    "define": {
      "freezeTableName": true 
    }
  },

	> sá»­ dá»¥ng freezeTableName Ä‘á»ƒ cho nÃ³ khÃ´ng tá»± Ä‘á»™ng thÃªm s 




4. CRUD vá»›i Sequelize 

	( https://sequelize.org/docs/v6/core-concepts/model-querying-basics/ )
 
	
	1. CREATE (Táº¡o má»›i dá»¯ liá»‡u) 

const user = await User.create({
  name: 'Nguyá»…n VÄƒn A',
  email: 'nguyenvana@example.com'
});

> Sequelize sáº½ tá»± Ä‘á»™ng táº¡o cÃ¢u lá»‡nh INSERT INTO dá»±a trÃªn model User. 


 	2. READ (Äá»c dá»¯ liá»‡u)
	

ğŸ‘‰ TÃ¬m táº¥t cáº£ báº£n ghi:

	const users = await User.findAll();

ğŸ‘‰ TÃ¬m theo Ä‘iá»u kiá»‡n:

	const user = await User.findOne({
  where: { email: 'nguyenvana@example.com' }
});

ğŸ‘‰ TÃ¬m theo ID:

const user = await User.findByPk(1); // TÃ¬m theo primary key


	3. UPDATE (Cáº­p nháº­t dá»¯ liá»‡u)

await User.update(
  { name: 'Nguyá»…n VÄƒn B' },
  { where: { id: 1 } }
);

> Sequelize sáº½ táº¡o cÃ¢u lá»‡nh UPDATE tÆ°Æ¡ng á»©ng.

	
	4. DELETE (XoÃ¡ dá»¯ liá»‡u)

await User.destroy({
  where: { id: 1 }
});


	LÆ°u Ã½:

Táº¡i sao káº¿t quáº£ tráº£ vá» lÃ  Sequelize instance (Entity) nhÆ°ng váº«n render ra object JSON trong EJS?
	
	+ Sequelize instance (nhÆ° user báº¡n nháº­n Ä‘Æ°á»£c) cÃ³ sáºµn phÆ°Æ¡ng thá»©c .toJSON() vÃ  toString(), nÃªn khi báº¡n truyá»n vÃ o EJS hoáº·c console.log(JSON.stringify(user)), nÃ³ tá»± Ä‘á»™ng chuyá»ƒn thÃ nh plain object.

	=> k cáº§n viáº¿t: 
const plainUser = user

	> .get({ plain: true }); // TÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i toJSON 
	
	hoáº·c 

 let user = await db.User.findOne({
      where: { email: data.email },
      raw: true,
    });


5. MongoDB vs MySQL


	1. MongoDB (NoSQL)
	
	+ Dá»¯ liá»‡u dáº¡ng document(JSON)
	+ linh hoáº¡t, k cáº§n schema 
	+ khÃ´ng há»— trá»£ join truyá»n thá»‘ng 
	+ tá»‘t cho dá»¯ liá»‡u phi cáº¥u trÃºc 
	+ linh hoáº¡t, dá»… scale 


	2. MySQL (SQL)

	+ Dá»¯ liá»‡u dáº¡ng báº£ng 
	+ cáº§n schema cá»‘ Ä‘á»‹nh 
	+ há»— trá»£ join máº¡nh 
	+ tá»‘t cho dá»¯ liá»‡u quan há»‡ 
	+ tuÃ¢n thá»§ ACID 

ğŸ”¹ NÃªn dÃ¹ng khi nÃ o?

MySQL: App tÃ i chÃ­nh, CRM, ERP, cáº§n JOIN vÃ  tÃ­nh chÃ­nh xÃ¡c cao.

MongoDB: Social app, MVP, dá»¯ liá»‡u linh hoáº¡t, scale lá»›n, cáº§n phÃ¡t triá»ƒn nhanh.


VÃ­ dá»¥ dá»± Ã¡n phÃ¹ há»£p SQL:

Há»‡ thá»‘ng ngÃ¢n hÃ ng, káº¿ toÃ¡n (quan há»‡ phá»©c táº¡p, cáº§n tÃ­nh chÃ­nh xÃ¡c).

Website thÆ°Æ¡ng máº¡i Ä‘iá»‡n tá»­ (quáº£n lÃ½ sáº£n pháº©m, khÃ¡ch hÃ ng, Ä‘Æ¡n hÃ ng).

á»¨ng dá»¥ng quáº£n lÃ½ trÆ°á»ng há»c (lá»›p há»c, sinh viÃªn, Ä‘iá»ƒm sá»‘).

Báº¥t cá»© app nÃ o mÃ  tÃ­nh nháº¥t quÃ¡n dá»¯ liá»‡u lÃ  sá»‘ 1.


VÃ­ dá»¥ dá»± Ã¡n phÃ¹ há»£p NoSQL:

Máº¡ng xÃ£ há»™i (bÃ i Ä‘Äƒng, bÃ¬nh luáº­n, likeâ€¦ lÆ°u dáº¡ng document).

Realtime chat (WebSocket + MongoDB/Redis).

Há»‡ thá»‘ng log, analytics, tracking (dá»¯ liá»‡u khá»•ng lá»“, cáº§n lÆ°u nhanh).

Game online (tráº¡ng thÃ¡i ngÆ°á»i chÆ¡i, leaderboardâ€¦).


6. KhÃ¡i niá»‡m ACL 

	+ Access Control List (ACL) trong backend lÃ  má»™t ká»¹ thuáº­t Ä‘á»ƒ kiá»ƒm soÃ¡t quyá»n truy cáº­p cá»§a ngÆ°á»i dÃ¹ng hoáº·c nhÃ³m ngÆ°á»i dÃ¹ng Ä‘áº¿n cÃ¡c tÃ i nguyÃªn cá»¥ thá»ƒ trong há»‡ thá»‘ng (nhÆ° API, file, dá»¯ liá»‡u...).


	+ ğŸ” ACL dÃ¹ng Ä‘á»ƒ lÃ m gÃ¬?

Kiá»ƒm soÃ¡t ai cÃ³ quyá»n xem / chá»‰nh sá»­a / xoÃ¡ / táº¡o gÃ¬

Báº£o máº­t há»‡ thá»‘ng

PhÃ¢n quyá»n rÃµ rÃ ng cho tá»«ng user, role	


7. CÃ¡c kiá»ƒu dá»¯ liá»‡u cá»§a Sequelize 

( https://sequelize.org/docs/v6/core-concepts/model-basics/#data-types )



8. Create Model(Table) with Sequelize 

	+ Ä‘á»ƒ táº¡o 1 model vÃ  push vÃ o database ta cáº§n 


	C1. Táº¡o auto vá»›i cÃ¢u lá»‡nh


npx sequelize-cli model:generate --name User --attributes firstName:string,lastName:string,email:string



	C2. tá»± táº¡o thá»§ cÃ´ng báº±ng viá»‡c táº¡o file trong model vÃ  migration

	* LÆ°u Ã½: TÃªn file bÃªn trong migration lÃ : migrate-....


	> sau khi oke cáº£ migration vÃ  model cháº¡y 

	npx sequelize-cli db:migrate

	
ChÃº Ã½: Ä‘á»ƒ trÃ¡nh cho tÃªn k Ä‘Ãºng nhÆ° Ä‘áº·t bá»‹ thÃªm S trong config.json thÃªm: 


"port": "8888",

"define": {
      "freezeTableName": true 
    }





9. Relationship in Sequelize 

	( https://sequelize.org/docs/v6/core-concepts/assocs/ )
	( https://sequelize.org/docs/v6/advanced-association-concepts/eager-loading/ )

	1. Thuáº­t ngá»¯ Eager Loading 

	+ Eager Loading trong Sequelize lÃ  ká»¹ thuáº­t táº£i trÆ°á»›c (preload) cÃ¡c dá»¯ liá»‡u liÃªn quan giá»¯a cÃ¡c báº£ng (models) trong cÃ¹ng má»™t truy váº¥n SQL thÃ´ng qua include, giÃºp trÃ¡nh viá»‡c truy váº¥n láº·p láº¡i nhiá»u láº§n (N+1 queries problem).

	ğŸ“Œ Hiá»ƒu Ä‘Æ¡n giáº£n:

Thay vÃ¬ láº¥y dá»¯ liá»‡u báº£ng chÃ­nh rá»“i láº¡i truy váº¥n riÃªng Ä‘á»ƒ láº¥y dá»¯ liá»‡u báº£ng liÃªn quan, Sequelize cho phÃ©p báº¡n láº¥y táº¥t cáº£ cÃ¹ng lÃºc.


	2. Relationship 


	>> ThÃ´ng thÆ°á»ng ta cÃ³ cÃ¡c má»‘i quan há»‡ nhÆ° sau 

	> One-to-One 
	> One-to-Many 
	> Many-to-Many 

	
	>> Sequelize provie 4 kiá»ƒu relationship thay tháº¿

	The HasOne association
	The BelongsTo association
	The HasMany association
	The BelongsToMany association


		1. A.hasOne(B)

	+ Quan há»‡: One-To-One
	+ Foreign key náº±m á»Ÿ: model B (target)


		2. A.belongsTo(B)

	Quan há»‡: One-To-One
	Foreign key náº±m á»Ÿ: model A (source)

		
		3. A.hasMany(B)

	Quan há»‡: One-To-Many
	Foreign key náº±m á»Ÿ: model B (target)
	

		4. A.belongsToMany(B, { through: 'C' })

	Quan há»‡: Many-To-Many
	Sá»­ dá»¥ng báº£ng trung gian: C (junction table)
	Sequelize sáº½ tá»± táº¡o báº£ng C vá»›i cÃ¡c khÃ³a ngoáº¡i (nhÆ° aId, bId) náº¿u chÆ°a cÃ³.

VD: 

module.exports = (sequelize, DataTypes) => {
  class Group extends Model {
    /**
     * Helper method for defining associations.
     * This method is not a part of Sequelize lifecycle.
     * The `models/index` file will call this method automatically.
     */
    static associate(models) {

      Group.hasMany(models.User);
      Group.belongsToMany(models.Role, { through: "GroupRole" });

    }
  }



  	
	3.Sá»­ dá»¥ng include

	+ Sá»­ dá»¥ng inclue cá»§a sequelize cÅ©ng giá»‘ng nhÆ° Ä‘ang sá»­ dá»¥ng JOIN 

	VD: 

+ Ta cÃ³ 2 model nhÆ° sau: 

// User model
User.hasMany(Post); // Má»™t user cÃ³ nhiá»u bÃ i post

// Post model
Post.belongsTo(User); // Má»™t post thuá»™c vá» má»™t user


> Truy váº¥n láº¥y ra táº¥t cáº£ user vÃ  bÃ i viáº¿t tÆ°Æ¡ng á»©ng vá»›i id cá»§a há»: 

const users = await User.findAll({
  include: Post, // hoáº·c { model: Post }
});

Äiá»u nÃ y tÆ°Æ¡ng Ä‘Æ°Æ¡ng vá»›i:

" SELECT * FROM Users
LEFT OUTER JOIN Posts ON Users.id = Posts.UserId; "


	* include nÃ¢ng cao 

3.1. Chá»‰ láº¥y má»™t sá»‘ cá»™t tá»« báº£ng liÃªn káº¿t:

const users = await User.findAll({
  include: {
    model: Post,
    attributes: ['title', 'createdAt']
  }
});

3.2. Äiá»u kiá»‡n lá»c trong include

const users = await User.findAll({
  include: {
    model: Post,
    where: {
      published: true
    }
  }
});



	
	4. Xá»­ lÃ½ lá»—i cÃ³ 2 foreign key khi tá»± khai bÃ¡o vÃ  sequelize generate 

	 
	VD:

	User.belongsTo(models.Group);
	groupID: DataTypes.INTEGER,

	> sáº½ cÃ³ 2 foreign key Ä‘Æ°á»£c sinh ra 

	+ Kháº¯c phá»¥c báº±ng cÃ¡ch chá»§ Ä‘á»™ng Ä‘Æ°a khai bÃ¡o foreign key cho nÃ³

User.belongsTo(models.Group, {
  foreignKey: "groupID" // dÃ¹ng chÃ­nh cá»™t báº¡n Ä‘á»‹nh nghÄ©a
});

	
	5. k in ra dá»¯ liá»‡u tá»« báº£ng trung gian 

 include: {
      model: db.Role,
      attributes: ["id", "url", "description"],
      through: { attributes: [] },
    },


	> through



10. CORS lÃ  gÃ¬ ? 

	Q: thÃ´ng thÆ°á»ng khi ta gá»i API tá»« FE Ä‘áº¿n BE mÃ  cÃ³ 2 domain khÃ¡c nhau thÃ¬ sáº½ gáº·p lá»—i CORS. Váº­y nÃ³ lÃ  gÃ¬ ?

	
	+ KhÃ¡i niá»‡m: 

CORS (viáº¿t táº¯t cá»§a: Cross-Origin Resource Sharing): lÃ  má»™t cÆ¡ cháº¿ báº£o máº­t cá»§a trÃ¬nh duyá»‡t, giÃºp kiá»ƒm soÃ¡t xem má»™t website (gá»i lÃ  origin) cÃ³ Ä‘Æ°á»£c phÃ©p truy cáº­p tÃ i nguyÃªn tá»« má»™t website khÃ¡c hay khÃ´ng.

	VD: 

Origin = protocol + domain + port

VÃ­ dá»¥:

https://example.com:443

http://localhost:3000

Náº¿u hai origin khÃ¡c nhau (khÃ¡c protocol, domain hoáº·c port), thÃ¬ khi frontend gá»­i request tá»›i backend á»Ÿ origin khÃ¡c, Ä‘Ã³ Ä‘Æ°á»£c gá»i lÃ  cross-origin request.


	2ï¸âƒ£ Táº¡i sao CORS tá»“n táº¡i?
	
	+ CORS sinh ra giÃºp cháº·n cÃ¡c request láº¡ Ä‘áº¿n BE mÃ  khÃ´ng Ä‘Æ°á»£c cho phÃ©p, trá»« khi ta cho phÃ©p thÃ´ng qua header  Access-Control-Allow-Origin.


	3ï¸âƒ£ CÃ¡ch hoáº¡t Ä‘á»™ng cÆ¡ báº£n cá»§a CORS

	B1: Khi frontend (á»Ÿ origin A - khÃ¡c domain) gá»­i request Ä‘áº¿n backend (á»Ÿ origin B - khÃ¡c 	domain), trÃ¬nh duyá»‡t sáº½ gá»­i kÃ¨m theo má»™t CORS check.

	B2: Náº¿u server B pháº£n há»“i vá»›i header Access-Control-Allow-Origin: A thÃ¬ trÃ¬nh duyá»‡t má»›i cho 	phÃ©p láº¥y dá»¯ liá»‡u.

	B3: Náº¿u khÃ´ng cÃ³ header nÃ y, trÃ¬nh duyá»‡t sáº½ cháº·n response (máº·c dÃ¹ request cÃ³ thá»ƒ Ä‘Ã£ Ä‘Æ°á»£c gá»­i 	thÃ nh cÃ´ng tá»« phÃ­a server).


ğŸ‘‰ TÃ³m láº¡i:
CORS lÃ  cÆ¡ cháº¿ kiá»ƒm soÃ¡t báº£o máº­t quan trá»ng cá»§a trÃ¬nh duyá»‡t, báº£o vá»‡ server khá»i viá»‡c bá»‹ gá»i tá»« nhá»¯ng website khÃ´ng Ä‘Æ°á»£c phÃ©p.

	

	
	2. Xá»­ lÃ½ CORS bÃªn server

	( https://stackoverflow.com/questions/18310394/no-access-control-allow-origin-node-apache-port-issue )

// server.js

// Add headers before the routes are defined
app.use(function (req, res, next) {

    // Website you wish to allow to connect
    res.setHeader('Access-Control-Allow-Origin', 'http://localhost:8888');

    // Request methods you wish to allow
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');

    // Request headers you wish to allow
    res.setHeader('Access-Control-Allow-Headers', 'X-Requested-With,content-type');

    // Set to true if you need the website to include cookies in the requests sent
    // to the API (e.g. in case you use sessions)
    res.setHeader('Access-Control-Allow-Credentials', true);

    // Pass to next layer of middleware
    next();
});


11. Session Storage vs Local Storage vs Cookies

	 1. Local Storage 
		
		+ Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u vÄ©nh viá»…n cho Ä‘áº¿n khi chá»§ Ä‘á»™ng thay Ä‘á»•i
		
		+ Dung lÆ°á»£ng khÃ¡ lá»›n (thÆ°á»ng tá»« 5MB Ä‘áº¿n 10MB, tÃ¹y trÃ¬nh duyá»‡t).
		
		+ Dá»¯ liá»‡u chá»‰ cÃ³ thá»ƒ truy cáº­p Ä‘Æ°á»£c bá»Ÿi cÃ¹ng domain Ä‘Ã£ táº¡o ra nÃ³.
		
		+ Chá»‰ há»— trá»£ lÆ°u dá»¯ liá»‡u dáº¡ng chuá»—i (string), nÃªn náº¿u muá»‘n lÆ°u object pháº£i dÃ¹ng JSON.stringify() vÃ  JSON.parse() Ä‘á»ƒ chuyá»ƒn Ä‘á»•i.
		
		+ KhÃ´ng tá»± Ä‘á»™ng gá»­i dá»¯ liá»‡u lÃªn server trong má»—i request HTTP.
		
		+ PhÃ¹ há»£p Ä‘á»ƒ lÆ°u nhá»¯ng dá»¯ liá»‡u khÃ´ng nháº¡y cáº£m nhÆ° theme (light/dark), user preference, token táº¡m thá»i...


	2ï¸âƒ£ Session Storage


Giá»‘ng gáº§n nhÆ° y há»‡t Local Storage vá» cÆ¡ cháº¿ lÆ°u trá»¯, nhÆ°ng chá»‰ tá»“n táº¡i trong 1 phiÃªn lÃ m viá»‡c (session).

Khi ngÆ°á»i dÃ¹ng Ä‘Ã³ng tab hoáº·c trÃ¬nh duyá»‡t => dá»¯ liá»‡u bá»‹ xÃ³a.

CÅ©ng cÃ³ dung lÆ°á»£ng khÃ¡ lá»›n (5MB trá»Ÿ lÃªn).

CÅ©ng khÃ´ng gá»­i kÃ¨m dá»¯ liá»‡u lÃªn server khi gá»i API.

ThÆ°á»ng dÃ¹ng Ä‘á»ƒ lÆ°u cÃ¡c dá»¯ liá»‡u táº¡m thá»i nhÆ° form Ä‘ang nháº­p dá»Ÿ, bÆ°á»›c hiá»‡n táº¡i cá»§a 1 wizard, v.v.

	
	3ï¸âƒ£ Cookies


Dá»¯ liá»‡u cÃ³ thá»ƒ Ä‘Æ°á»£c lÆ°u trong 1 thá»i gian xÃ¡c Ä‘á»‹nh (tÃ¹y expires hoáº·c max-age) hoáº·c phiÃªn lÃ m viá»‡c.

Dung lÆ°á»£ng ráº¥t nhá», thÆ°á»ng giá»›i háº¡n ~4KB.

Quan trá»ng: cookie Ä‘Æ°á»£c gá»­i tá»± Ä‘á»™ng lÃªn server trong má»—i request HTTP (náº¿u cÃ¹ng domain, cÃ¹ng path, security rule cho phÃ©p).

ThÃ­ch há»£p Ä‘á»ƒ lÆ°u thÃ´ng tin cáº§n gá»­i kÃ¨m server má»—i láº§n gá»i nhÆ°: session id, JWT token, tracking info, v.v.

CÃ³ thá»ƒ cáº¥u hÃ¬nh báº£o máº­t nhÆ° Secure, HttpOnly, SameSite Ä‘á»ƒ háº¡n cháº¿ rá»§i ro (XSS, CSRFâ€¦).

Cookies cÃ³ thá»ƒ truy cáº­p tá»« cáº£ client-side (náº¿u khÃ´ng Ä‘áº·t HttpOnly) hoáº·c chá»‰ server-side.




11. JWT - JSON Web Token 

	âœ… 1. JWT lÃ  gÃ¬?

LÃ  má»™t chuá»—i token mÃ£ hÃ³a, Ä‘áº¡i diá»‡n cho thÃ´ng tin ngÆ°á»i dÃ¹ng Ä‘Ã£ xÃ¡c thá»±c.

GiÃºp xÃ¡c minh danh tÃ­nh vÃ  Ä‘áº£m báº£o ráº±ng dá»¯ liá»‡u truyá»n giá»¯a client vÃ  server lÃ  Ä‘Ã¡ng tin cáº­y vÃ  khÃ´ng bá»‹ giáº£ máº¡o.

	âœ… 2. Cáº¥u trÃºc cá»§a JWT

	JWT cÃ³ 3 pháº§n chÃ­nh, Ä‘Æ°á»£c ngÄƒn cÃ¡ch báº±ng dáº¥u . (dot):

	<Header>.<Payload>.<Signature>

		âœ… 1. Header:
			
		{
 		 "alg": "HS256",
  		"typ": "JWT"
		}

alg: thuáº­t toÃ¡n dÃ¹ng Ä‘á»ƒ kÃ½ (thÆ°á»ng lÃ  HS256).

typ: kiá»ƒu token (luÃ´n lÃ  JWT).

		âœ… 2. Payload:

Chá»©a dá»¯ liá»‡u (claims) nhÆ° user ID, username, vai trÃ²...

CÃ³ thá»ƒ cÃ³ cÃ¡c claims chuáº©n: iss (issuer), exp (expiration), sub (subject), iat (issued at).
		

		âœ… 3. Signature:
		DÃ¹ng Ä‘á»ƒ xÃ¡c minh tÃ­nh toÃ n váº¹n cá»§a token.

		ÄÆ°á»£c táº¡o báº±ng cÃ´ng thá»©c:	
	
		HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret
)

	âœ… 3. CÃ¡ch JWT hoáº¡t Ä‘á»™ng

ğŸ§© BÆ°á»›c 1: ÄÄƒng nháº­p
Client gá»­i thÃ´ng tin Ä‘Äƒng nháº­p (username, password) Ä‘áº¿n server.

Server xÃ¡c minh -> náº¿u há»£p lá»‡, táº¡o JWT vÃ  tráº£ vá» cho client.


ğŸ§© BÆ°á»›c 2: Sá»­ dá»¥ng token
Client lÆ°u JWT (thÆ°á»ng trong localStorage hoáº·c cookie).

Má»—i request tiáº¿p theo Ä‘áº¿n server Ä‘á»u Ä‘Ã­nh kÃ¨m token qua Authorization header:

Authorization: Bearer <token>


ğŸ§© BÆ°á»›c 3: Server xÃ¡c minh token
Server dÃ¹ng secret/key Ä‘á»ƒ giáº£i mÃ£ vÃ  xÃ¡c minh chá»¯ kÃ½.

Náº¿u há»£p lá»‡ â†’ xá»­ lÃ½ request. Náº¿u khÃ´ng há»£p lá»‡ â†’ tráº£ vá» lá»—i 401.

âœ… 4. Vai trÃ² quan trá»ng cá»§a JWT

Vai trÃ²				Ã nghÄ©a
ğŸ” XÃ¡c thá»±c			GiÃºp xÃ¡c minh user Ä‘Ã£ Ä‘Äƒng nháº­p chÆ°a
ğŸ“œ KhÃ´ng tráº¡ng thÃ¡i (Stateless)	Server khÃ´ng cáº§n lÆ°u session â€” táº¥t cáº£ náº±m trong token
ğŸ¯ PhÃ¢n quyá»n			Dá»… dÃ ng kiá»ƒm tra role/permission trong payload
âš¡ Nhanh & tiá»‡n lá»£i		KhÃ´ng pháº£i truy váº¥n database má»—i láº§n xÃ¡c minh
ğŸŒ Phá»• biáº¿n			ÄÆ°á»£c dÃ¹ng rá»™ng rÃ£i trong API RESTful, SPA, microservices, v.v.


âœ… 5. LÆ°u Ã½ báº£o máº­t khi dÃ¹ng JWT

KhÃ´ng nÃªn lÆ°u token trong localStorage náº¿u muá»‘n trÃ¡nh XSS (nÃªn dÃ¹ng HttpOnly Cookie).

Token cáº§n háº¿t háº¡n (exp) Ä‘á»ƒ trÃ¡nh bá»‹ sá»­ dá»¥ng lÃ¢u dÃ i.

DÃ¹ng HTTPS Ä‘á»ƒ báº£o vá»‡ token khá»i bá»‹ Ä‘Ã¡nh cáº¯p trÃªn máº¡ng.

KhÃ´ng nÃªn lÆ°u thÃ´ng tin nháº¡y cáº£m trong payload (vÃ¬ nÃ³ khÃ´ng Ä‘Æ°á»£c mÃ£ hÃ³a, chá»‰ Ä‘Æ°á»£c mÃ£ hÃ³a chá»¯ kÃ½).


âœ… 6. Má»‘i quan há»‡ cá»¥ thá»ƒ giá»¯a JWT vÃ  Cookies


	âœ… VÃ­ dá»¥ má»‘i quan há»‡: JWT lÆ°u trong Cookie

	ğŸ§¾ BÆ°á»›c 1: Sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng
	Server táº¡o JWT, sau Ä‘Ã³ set vÃ o cookie:

	Set-Cookie: token=eyJhbGci...; HttpOnly; Secure; SameSite=Strict


	ğŸŒ BÆ°á»›c 2: TrÃ¬nh duyá»‡t lÆ°u cookie
	Cookie chá»©a JWT sáº½ Ä‘Æ°á»£c lÆ°u vÃ  gá»­i tá»± Ä‘á»™ng trong cÃ¡c request tiáº¿p theo:
	
	ğŸ” BÆ°á»›c 3: Server xÃ¡c thá»±c JWT tá»« cookie
	Server láº¥y JWT tá»« cookie â†’ xÃ¡c minh â†’ náº¿u há»£p lá»‡ thÃ¬ cho truy cáº­p tÃ i nguyÃªn.


	
12. Sá»­ dá»¥ng JWT 

	( https://github.com/auth0/node-jsonwebtoken )
	
	+ Äá»ƒ sá»­ dá»¥ng token ta cáº§n pháº£i táº¡o vÃ  verify nÃ³ 

	+ Sáº½ cÃ³ 2 cÃ¡ch viáº¿t. tuy nhiÃªn ta sáº½ thá»‘ng nháº¥t dÃ¹ng cÃ¡ch Ä‘á»“ng bá»™ Ä‘á»ƒ k cáº§n truyá»n callback, dÃ¹ng async/await 

	VD: hÃ m create JWT vÃ  verify JWT

const createJWT = () => {
  try {
    let data = {
      foo: "car",
    };
   let token = jwt.sign(payload, process.env.JWT_SECRET, { expiresIn: "1h" });
    return token;
  } catch (error) {
    console.log("Wrong");
    return null;
  }
};

const verifyJWT = (token) => {
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    return decoded;
  } catch (err) {
    console.log("Wrong");
    return null;
  }
};



13. Sá»­ dá»¥ng cookie-parser 

	KN: 

	cookie-parser lÃ  má»™t middleware phá»• biáº¿n trong Node.js (thÆ°á»ng dÃ¹ng vá»›i Express.js) giÃºp phÃ¢n tÃ­ch (parse) cÃ¡c cookie Ä‘Æ°á»£c gá»­i tá»« client trong cÃ¡c HTTP request. Khi client gá»­i request Ä‘áº¿n server, cÃ¡c cookie Ä‘Æ°á»£c gá»­i kÃ¨m trong header, vÃ  cookie-parser giÃºp báº¡n dá»… dÃ ng truy cáº­p vÃ  xá»­ lÃ½ chÃºng.


	CÃ¡ch sá»­ dá»¥ng: 

const express = require('express');
const cookieParser = require('cookie-parser');

const app = express();

// DÃ¹ng middleware cookie-parser
app.use(cookieParser('your-secret-key'));


	TÃ­nh nÄƒng 

TÃ­nh nÄƒng	MÃ´ táº£
Parse cookie	Biáº¿n Cookie trong request.headers thÃ nh Ä‘á»‘i tÆ°á»£ng JavaScript.

Há»— trá»£ signed cookies	DÃ¹ng secret key Ä‘á»ƒ báº£o vá»‡ cookie, trÃ¡nh bá»‹ sá»­a tá»« client.

Truy cáº­p dá»… dÃ ng qua req.cookies vÃ  req.signedCookies	

	
	* LÆ°u Ã½: res.cookie() cÃ³ sáºµn trong express nhÆ°ng req.cookie thÃ¬ khÃ´ng 


	VD:

	+ sau khi login ta sáº½ set cookie vÃ o web vá»›i cÃ¡c giÃ¡ trá»‹ nháº¥t Ä‘á»‹nh 

const signInUser = async (req, res) => {
  try {
    const data = await handleSignIn(req.body);

    // Set Cookie
    res.cookie("jwt", data.DT.access_token, { httpOnly: true });

    return res.status(200).json({
      EM: data.EM,
      EC: data.EC,
      data: data.DT,
    });
  } catch (error) {
    return res.status(500).json({
      EM: "Error from server",
      EC: "-1",
      data: "",
    });
  }
};

	> tuy nhiÃªn sáº½ cÃ³ lá»—i xáº£y ra vÃ  ta cáº§n pháº£i chá»‰nh sá»­a á»Ÿ axios config má»›i cÃ³ thá»ƒ set dc cookie 

	 + instance.defaults.withCredentials = true;
	
	Giáº£i thÃ­ch: 

 Khi báº¡n gá»­i request tá»« trÃ¬nh duyá»‡t Ä‘áº¿n má»™t origin khÃ¡c (cross-origin request), trÃ¬nh duyá»‡t sáº½ KHÃ”NG gá»­i cookie kÃ¨m theo náº¿u báº¡n khÃ´ng báº­t withCredentials.

Máº·c Ä‘á»‹nh axios sáº½ KHÃ”NG gá»­i cookie kÃ¨m theo trong request khi frontend vÃ  backend khÃ¡c origin.

withCredentials: true yÃªu cáº§u axios gá»­i cookie (hoáº·c nháº­n cookie) trong request dÃ¹ request Ä‘Ã³ lÃ  cross-origin.


	+ cÃ³ cÃ¡i nÃ y khi client gá»­i req lÃªn server sáº½ gá»­i kÃ¨m táº¥t cáº£ cookie cá»§a web mÃ  thá»a mÃ£n Ä‘iá»u kiá»‡n lÃªn ()
	
	
	>> ta cÃ³ thá»ƒ tá»± custome req. theo Ã½ mÃ¬nh: 

  if (decoded) {
      req.user = decoded;
      next();
    } else {



14. Bearer Authentication - XÃ¡c thá»±c vá»›i Header Token 

	1. Bearer Authentication 
	
	+ lÃ  phÆ°Æ¡ng phÃ¡p xÃ¡c thá»±c trong Ä‘Ã³ client gá»­i token trong pháº§n Authorization header cá»§a HTTP request Ä‘á»ƒ chá»©ng minh danh tÃ­nh.

	CÃº phÃ¡p: Authorization: Bearer <token>


âœ… Khi nÃ o dÃ¹ng cÃ¡i nÃ o?
TrÆ°á»ng há»£p sá»­ dá»¥ng				NÃªn dÃ¹ng gÃ¬
App SPA (React, Vue, Angular)			Bearer Token (hoáº·c JWT token-based)
Web truyá»n thá»‘ng (SSR: PHP, Laravel, Django...)	Cookie
Cáº§n báº£o máº­t cao (trÃ¡nh XSS)			Cookie + HttpOnly
Cáº§n trÃ¡nh CSRF					Bearer Token hoáº·c Cookie vá»›i SameSite=strict

	
	2. Sá»­ dá»¥ng bearer token sao cho khÃ´ng bá»‹ lá»—i CORS 
	
	+ ThÃ´ng thÆ°á»ng ta sáº½ lÆ°u token á»Ÿ localstorage sau Ä‘Ã³ truyá»n qua header authorization 

	> sá»­ dá»¥ng vá»›i axios 

	instance.defaults.headers.common[
  "Authorization"
] = `Bearer ${localStorage.getItem("token")}`;

	
	+ Ta cáº§n pháº£i config thÃªm bÃªn server Ä‘á»ƒ trÃ¡nh lá»—i 

 res.setHeader(
      "Access-Control-Allow-Headers",
      "X-Requested-With,content-type, Authorization"
    );

    // Set to true if you need the website to include cookies in the requests sent
    // to the API (e.g. in case you use sessions)
    res.setHeader("Access-Control-Allow-Credentials", true);

    if (req.method === "OPTIONS") {
      return res.sendStatus(200);
    }

	> ThÃªm authorization vÃ  return status 



15. Má»Ÿ rá»™ng. Báº£o máº­t JWT token vÃ  cÃ¡c loáº¡i hÃ¬nh táº¥n cÃ´ng 

ğŸ”’ Káº¿t luáº­n:
NÃªn dÃ¹ng cookie cÃ³ flag HttpOnly + Secure + SameSite=Strict/Lax náº¿u báº¡n muá»‘n báº£o máº­t JWT tá»‘i Ä‘a.


âš ï¸ 2. Nhá»¯ng kiá»ƒu táº¥n cÃ´ng phá»• biáº¿n liÃªn quan Ä‘áº¿n JWT (vÃ  web app nÃ³i chung)

a. XSS (Cross-Site Scripting)
Káº» táº¥n cÃ´ng chÃ¨n mÃ£ JavaScript Ä‘á»™c vÃ o trang web (vÃ­ dá»¥: trong form, comment, URLâ€¦)

Náº¿u JWT lÆ°u á»Ÿ localStorage, JS cÃ³ thá»ƒ localStorage.getItem('token') vÃ  gá»­i token vá» server cá»§a hacker.


b. CSRF (Cross-Site Request Forgery)
Táº¥n cÃ´ng khi dÃ¹ng cookie-based auth

VÃ­ dá»¥: ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p vÃ o bank.com, hacker gá»­i 1 yÃªu cáº§u giáº£ máº¡o tá»« evil.com, trÃ¬nh duyá»‡t váº«n gá»­i cookie theo máº·c Ä‘á»‹nh.


	DÃ¹ng SameSite=Strict hoáº·c Lax trong cookie

....

16. Refresh token.

ğŸ” 1. Refresh Token lÃ  gÃ¬?
Access Token: LÃ  token chÃ­nh Ä‘á»ƒ truy cáº­p API. ThÆ°á»ng cÃ³ thá»i gian sá»‘ng ngáº¯n (vÃ­ dá»¥: 15 phÃºt, 1 giá») Ä‘á»ƒ giáº£m thiá»ƒu rá»§i ro náº¿u bá»‹ lá»™.

Refresh Token: LÃ  token dÃ i háº¡n hÆ¡n (cÃ³ thá»ƒ sá»‘ng vÃ i ngÃ y, vÃ i tuáº§n), dÃ¹ng Ä‘á»ƒ xin cáº¥p láº¡i Access Token má»›i mÃ  khÃ´ng cáº§n ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p láº¡i.


ğŸ” 2. NguyÃªn lÃ½ hoáº¡t Ä‘á»™ng

Giáº£ sá»­ há»‡ thá»‘ng sá»­ dá»¥ng JWT, Ä‘Ã¢y lÃ  cÃ¡ch hoáº¡t Ä‘á»™ng:

ğŸ”¹ Khi ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p:
Server xÃ¡c thá»±c thÃ´ng tin tÃ i khoáº£n.

Server tráº£ vá» cho client:

accessToken (háº¡n 15 phÃºt cháº³ng háº¡n)

refreshToken (háº¡n 7 ngÃ y hoáº·c hÆ¡n)

ğŸ”¹ Khi accessToken háº¿t háº¡n:
Client tá»± Ä‘á»™ng gá»­i refreshToken lÃªn server (qua endpoint nhÆ° /refresh-token).

Server kiá»ƒm tra tÃ­nh há»£p lá»‡ cá»§a refreshToken:

Náº¿u há»£p lá»‡ â†’ cáº¥p láº¡i accessToken má»›i (vÃ  cÃ³ thá»ƒ lÃ  refreshToken má»›i).

Náº¿u khÃ´ng há»£p lá»‡ â†’ yÃªu cáº§u ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p láº¡i.

ğŸ”¹ Khi ngÆ°á»i dÃ¹ng logout:
Server sáº½ xÃ³a hoáº·c vÃ´ hiá»‡u hÃ³a refreshToken.







	
	
	